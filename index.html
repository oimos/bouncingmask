<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Bouncing Canvas Mask</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="manifest" href="site.webmanifest">
        <link rel="apple-touch-icon" href="icon.png">

        <style>
          .canvas{
            cursor: pointer;
          }
          .canvas:hover{
            opacity: .4;
          }
          .canvas[data-random="true"]{
            border: 1px solid red;
          }
          @media screen and (max-width:600px) {
            .canvas{
              width: 100px;
              height: 100px;
            }
          }
        </style>
    </head>
    <body>

        <canvas class="canvas" width="200" height="200"
                data-intensity="0.2"
                data-src="https://r.r10s.jp/com/img/home/smart/topbanner/campaign/201702/sports/2017_vissel_win_pc_314x314.jpg"
                data-url="http://yahoo.co.jp"
                data-random="true">
        </canvas>

        <canvas class="canvas" width="100" height="100"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/home/smart/topbanner/campaign/201702/sports/2017_vissel_win_pc_314x314.jpg"
                 data-url="http://google.co.jp">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/thumb/200309/message/flash/201709/20170921_asuraku_314x314.gif"
                 data-random="true">
        </canvas>
        <canvas  class="canvas" width="200" height="200"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/evt/event/rmagazine/_cmn/img/main/2017/top_0920_researchvol12.jpg"
                 data-random="true">
        </canvas>
        <canvas class="canvas" width="100" height="100"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/home/smart/topbanner/campaign/201702/sports/2017_vissel_win_pc_314x314.jpg"
                 data-random="true">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/home/smart/topbanner/campaign/201702/sports/2017_vissel_win_pc_314x314.jpg">
        </canvas>
        <canvas  class="canvas" width="200" height="200"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/thumb/200309/message/flash/201709/20170921_asuraku_314x314.gif">
        </canvas>
        <canvas class="canvas" width="100" height="100"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/evt/event/rmagazine/_cmn/img/main/2017/top_0920_researchvol12.jpg">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                data-intensity="0.2"
                 data-src="https://r.r10s.jp/com/img/home/smart/topbanner/campaign/201702/sports/2017_vissel_win_pc_314x314.jpg">
        </canvas>


        <script>
        var MAX = 20; // Number of Edges
        var CENTER_POS = {x:100, y:100};
        var RADIUS = 50;
        var FPS = 60; // only for < IE9
        var BOUNCINGSPEED = 5;

        var Point = function(centerPos, radius, degree, range, targetEl){
          this.pointX = undefined;
          this.pointY = undefined;
          this.centerX = undefined;
          this.centerY = undefined;
          this.radian = undefined;
          this.image = undefined;
          this.rotation = 0;
          this.radius = radius;
          this.centerPos = centerPos;
          this.degree = degree;
          this.range = range;
          this.target = targetEl;
          this.getElements();
          this.setPoints();
        }

        Point.prototype = {
          getElements: function(){
            this.radian = this.degree * (Math.PI / 180);
            this.centerX = this.target.getAttribute('width') * 0.5;
            this.centerY = this.target.getAttribute('height') * 0.5;
            this.speed = Math.random() * 10 + BOUNCINGSPEED ;
            this.rotation = 0;
            this.addPos = 0;
          },
          setPoints: function(){
            this.addPos = Math.cos(this.rotation * ( Math.PI / 180) ) * this.range;
            this.radius += this.addPos;
            this.pointX = Math.cos(this.radian) * this.radius + this.centerX;
            this.pointY = Math.sin(this.radian) * this.radius + this.centerY;
            this.rotation += this.speed;
            this.rotation = (this.rotation > 360) ? this.rotation - 360 : this.rotation;
          }
        }

        var AnimatePoints = function(targetNode, elOrder){
          this.el = targetNode;
          this.elOrder = elOrder;
          this.getElements();
          this.init();
          this.events();
        }

        AnimatePoints.prototype = {
          getElements: function(){
            this.ctx = this.el.getContext('2d');
            this.ctxDiameter = this.el.width;
            this.ctxRadius = this.ctxDiameter * 0.5;
            this.intensity = this.el.getAttribute('data-intensity') || 0.3;
            this.src = this.el.getAttribute('data-src');
            this.isRandom = this.el.getAttribute('data-random');
            this.link = this.el.getAttribute('data-url');
            this.point = [];
            this.rota = 360 / MAX;
            this.isAnimate = true;
            this.loop = undefined;
            this.image = new Image();
            if(this.isRandom == 'true'){
              this.image.src = imgArray[imgPos];
              imgPos++;
            } else {
              this.image.src = this.src;
            }
          },
          init: function(){
            var that = this;
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) { window.setTimeout(callback, 1000 / FPS) };

            for(var i = 0; i < MAX; i++){
              this.point[i] = new Point(CENTER_POS, this.ctxRadius, this.rota * i, this.intensity, this.el);
            }

            that.loop = function(){
                if(that.isAnimate){
                  that.update();
                  requestAnimationFrame(that.loop);
                }
              }
            that.loop();

          },
          update: function() {
            var that = this;
            for(var i = 0; i < MAX; i++){
              that.point[i].setPoints();
            }
            that.draw();
          },
          draw: function() {
            var that = this;

            //Clear the frame
            that.ctx.clearRect(0, 0, that.el.width, that.el.height);

            //Load a masking image
            that.ctx.drawImage(that.image, 0, 0, that.ctxDiameter, that.ctxDiameter)

            //Adjust masking
            that.ctx.globalCompositeOperation = 'destination-atop';

            //Draw a circle with bezier curve
            that.ctx.beginPath();
            var xcFirst = (that.point[0].pointX + that.point[MAX - 1].pointX) / 2;
            var ycFirst = (that.point[0].pointY + that.point[MAX - 1].pointY) / 2;

            that.ctx.moveTo(xcFirst, ycFirst);
            for(var j = 0; j < MAX - 1; j++){
              var xc = (that.point[j].pointX + that.point[j + 1].pointX) / 2;
              var yc = (that.point[j].pointY + that.point[j + 1].pointY) / 2;
              that.ctx.quadraticCurveTo(that.point[j].pointX, that.point[j].pointY, xc, yc);
            }
            that.ctx.quadraticCurveTo(that.point[j].pointX, that.point[j].pointY, xcFirst, ycFirst);
            that.ctx.closePath();
            that.ctx.fill('evenodd');
          },
          events: function(e){
            this.el.addEventListener('click', this.pageTransition.bind(this), false);
            this.el.addEventListener('mouseover', this.pauseBounce.bind(e, this), false);
            this.el.addEventListener('mouseout', this.resumeBounce.bind(e, this), false);
          },
          pageTransition: function(){
            window.location = this.link;
          },
          pauseBounce: function(e){
            var that = e;
            that.isAnimate = false;
          },
          resumeBounce: function(e){
            var that = e;
            that.isAnimate = true;
            that.loop();
          }
        }


        var targetNode = document.querySelectorAll('canvas');
        var randomImgEl = document.querySelectorAll('canvas[data-random="true"]');
        var imgArray = [];
        var imgPos = 0;
        randomImgEl.forEach(function(el){
          imgArray.push(el.getAttribute('data-src'));
        });
        function shuffle(a) {
            var j, x, i;
            for (i = a.length; i; i--) {
                j = Math.floor(Math.random() * i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
            }
            return a;
        }
        imgArray = shuffle(imgArray);

        for(var i = 0; i < targetNode.length; i++){
          var animatePoints = new AnimatePoints(targetNode[i], i);
        }
        </script>
    </body>
</html>