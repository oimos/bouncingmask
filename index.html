<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Bouncing Canvas Mask</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="manifest" href="site.webmanifest">
        <link rel="apple-touch-icon" href="icon.png">
    </head>
    <body>
        <canvas class="canvas" width="200" height="200"
                 data-src="http://loremflickr.com/320/320?random=1">
        </canvas>
        <canvas class="canvas" width="100" height="100"
                 data-src="http://loremflickr.com/320/320?random=2">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                 data-src="http://loremflickr.com/320/320?random=3">
        </canvas>
        <canvas  class="canvas" width="200" height="200"
                 data-src="http://loremflickr.com/320/320?random=4">
        </canvas>
        <canvas class="canvas" width="100" height="100"
                 data-src="http://loremflickr.com/320/320?random=5">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                 data-src="http://loremflickr.com/320/320?random=6">
        </canvas>
        <canvas  class="canvas" width="200" height="200"
                 data-src="http://loremflickr.com/320/320?random=7">
        </canvas>
        <canvas class="canvas" width="100" height="100"
                 data-src="http://loremflickr.com/320/320?random=8">
        </canvas>
        <canvas class="canvas" width="50" height="50"
                 data-src="http://loremflickr.com/320/320?random=9">
        </canvas>


        <script>
        var MAX = 10;
        var CENTER_POS = {x:100, y:100};
        var RADIUS = 100;
        var FPS = 20;
      
        var Point = function(centerPos, radius, degree, range, targetEl){
          this.pointX = undefined;
          this.pointY = undefined;
          this.centerX = undefined;
          this.centerY = undefined;
          this.radian = undefined;
          this.image = undefined;
          this.rotation = 0;
          this.radius = radius;
          this.centerPos = centerPos;
          this.degree = degree;
          this.range = range;
          this.target = targetEl;
          // console.log(range)
          this.getElements();
          this.setPoints();
        }

        Point.prototype = {
          getElements: function(){
            this.radian = this.degree * (Math.PI / 180);
            this.centerX = this.target.getAttribute('width') * 0.5;
            this.centerY = this.target.getAttribute('height') * 0.5;
            this.speed = Math.random() * 10 + 5 ;
            this.movement = Math.random()  ;
            this.rotation = 0;
            this.addPos = 0;
          },
          setPoints: function(){
            this.addPos = Math.cos(this.rotation * ( Math.PI / 180) ) * this.range;
            this.radius += this.addPos;
            this.pointX = Math.cos(this.radian) * this.radius + this.centerX;
            this.pointY = Math.sin(this.radian) * this.radius + this.centerY;
            this.rotation += this.speed;
            this.rotation = (this.rotation > 360) ? this.rotation - 360 : this.rotation;
          }
        }

        var AnimatePoints = function(targetNode, elOrder){
          this.el = targetNode;
          this.elOrder = elOrder;
          this.getElements();
          this.init();
        }

        AnimatePoints.prototype = {
          getElements: function(){
            this.ctx = this.el.getContext('2d');
            this.ctxDiameter = this.el.width * 0.4;
            this.src = this.el.getAttribute('data-src');
            this.image = new Image();
            this.image.src = this.src;
            this.point = [];
            this.rota = 360 / MAX;
            this.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
          },
          init: function(){
            var that = this;
            for(var i = 0; i < MAX; i++){
              this.point[i] = new Point(CENTER_POS, this.ctxDiameter, this.rota * i, Math.random(), this.el);
            }
            if( this.isIE9Lower() && this.isIE9Lower() <= 9 ){
              var loop = function(){
                that.update();
                setTimeout(loop, 1000 / FPS)
              }
            } else {
              var loop = function(){
                that.update();
                this.requestAnimationFrame(loop)
              };
            }
            loop();
          },
          update: function() {
            var that = this;
            for(var i = 0; i < MAX; i++){
              that.point[i].setPoints();
            }
            that.draw();
          },
          draw: function() {
            var that = this;

            //Clear the frame
            that.ctx.clearRect(0, 0, that.el.width, that.el.height);

            //Load a masking image
            that.ctx.drawImage(that.image, 0, 0, RADIUS * 4, RADIUS * 2.5)

            //Adjust masking
            that.ctx.globalCompositeOperation = 'destination-atop';

            //Draw a circle with bezier curve
            that.ctx.beginPath();
            var xcFirst = (that.point[0].pointX + that.point[MAX - 1].pointX) / 2;
            var ycFirst = (that.point[0].pointY + that.point[MAX - 1].pointY) / 2;

            that.ctx.moveTo(xcFirst, ycFirst);
            for(var j = 0; j < MAX - 1; j++){
              var xc = (that.point[j].pointX + that.point[j + 1].pointX) / 2;
              var yc = (that.point[j].pointY + that.point[j + 1].pointY) / 2;
              that.ctx.quadraticCurveTo(that.point[j].pointX, that.point[j].pointY, xc, yc);
            }
            that.ctx.quadraticCurveTo(that.point[j].pointX, that.point[j].pointY, xcFirst, ycFirst);
            that.ctx.closePath();
            that.ctx.fill('evenodd');
          },
          isIE9Lower: function(){
            var userNav = window.navigator.userAgent.toLowerCase();
            return (userNav.indexOf('msie') == true) ? parseInt(userNav.split('msie')[1]) : false;
          }
        }
        var targetNode = document.querySelectorAll('canvas')
        for(var i = 0; i < targetNode.length; i++){
          var animatePoints = new AnimatePoints(targetNode[i], i);
        }
        </script>
    </body>
</html>